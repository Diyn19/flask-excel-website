import pandas as pd
from flask import Flask, render_template, request
import math

app = Flask(__name__)

# 載入 Excel 並清理欄位名稱
def load_full_data():
    df = pd.read_excel('data.xlsx', header=13)
    df.columns = df.columns.str.replace('\n', '', regex=False)  # 移除欄位中的換行符號
    df = df.fillna('')  # 將 NaN 或 NaT 填成空白
    return df

@app.route('/')
def index():
    df = load_full_data()

    # 僅保留首頁顯示欄位
    display_columns = ['門市編號', '門市名稱', '鄉鎮市區', 'PMQ2檢核', 'EDC檢核', '發票機檢核', '數量']
    df = df[[col for col in display_columns if col in df.columns]]

    # 關鍵字搜尋
    keyword = request.args.get('keyword', '')
    if keyword:
        df = df[df.apply(lambda row: row.astype(str).str.contains(keyword, case=False).any(), axis=1)]

    return render_template('index.html', tables=df.to_dict(orient='records'), keyword=keyword)

@app.route('/<name>')
def person_page(name):
    try:
        # 讀取 A1:J6 (不含標題)、J7 為標題列、J8 開始為資料列
        df_top = pd.read_excel('data.xlsx', sheet_name=name, usecols="A:J", nrows=6, header=None)
        df_top = df_top.fillna('').applymap(lambda x: round(x, 2) if isinstance(x, (float, int)) else x)

        # 從第7列開始重新讀取資料（標題+資料）
        df_rest = pd.read_excel('data.xlsx', sheet_name=name, usecols="A:J", skiprows=6)
        df_rest.columns = df_rest.columns.str.replace('\n', '', regex=False)
        df_rest = df_rest.fillna('').applymap(lambda x: round(x, 2) if isinstance(x, (float, int)) else x)

        # 將上段與下段資料分別傳給模板
        tables = df_top.values.tolist() + df_rest.values.tolist()
        return render_template('index.html', tables=tables, keyword=name, personal=True)
    except Exception as e:
        return f"找不到 {name} 的工作表 或發生錯誤: {e}", 404

if __name__ == '__main__':
    app.run(debug=True)