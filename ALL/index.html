<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>åˆ—å°è¨ˆè²»ç³»çµ±</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        table { border-collapse: collapse; margin: 10px 0; width: 80%; }
        th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left;}
        th { background-color: #ccc !important; }
        .header-flex { display:flex; justify-content:space-between; align-items:center; width:80%; }
        .msg { margin: 10px 0; color: green; font-weight: bold; }
        .err { margin: 10px 0; color: red; font-weight: bold; }
        input[type="number"], input[type="text"] { width: 140px; }
        .btn-group { display:flex; gap:10px; margin-top: 10px; }
        table.contract-table th {text-align: center; background-color: #3399FF !important;color: white !important;}
        button {
            padding: 10px 15px;
            font-size: 20px;
            margin: 5px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
		.search-label {
			font-family: "Microsoft JhengHei", sans-serif;
			font-size: 18px;
		}
		.search-input {
			font-family: "Microsoft JhengHei", sans-serif;
			font-size: 16px;
			padding: 4px 6px;
		}
		.search-btn {
			font-family: "Microsoft JhengHei", sans-serif;
			font-size: 16px;
			padding: 6px 12px;
		}
    </style>
</head>
<body>
    <h2>åˆ—å°è¨ˆè²»ç³»çµ±</h2>

	<!-- æŸ¥è©¢è¨­å‚™æˆ–å®¢æˆ¶ -->
	<form method="POST" style="margin-bottom: 12px;">
		<input type="hidden" name="mode" value="query">
		<label class="search-label">è¨­å‚™ç·¨è™Ÿ / å®¢æˆ¶åç¨±(æ¦‚ç•¥):
			<input type="text" name="device_id" required class="search-input">
		</label>
		<button type="submit" class="search-btn">æŸ¥è©¢</button>
	</form>

    {% if message %}
        <div class="{{ 'msg' if message.startswith('âœ…') else 'err' }}">{{ message }}</div>
    {% endif %}

    <!-- è‹¥æ‰¾åˆ°å¤šç­†ç›¸ç¬¦çš„å®¢æˆ¶ -->
    {% if matches %}
      <div style="margin-top: 20px;">
        <h3>ğŸ” æ‰¾åˆ°å¤šç­†ç›¸ç¬¦çš„å®¢æˆ¶ï¼Œè«‹é¸æ“‡ï¼š</h3>
        <table border="1" cellspacing="0" cellpadding="6" style="border-collapse: collapse; width: 60%;">
          <thead style="background-color: #f2f2f2;">
            <tr>
              <th>è¨­å‚™ç·¨è™Ÿ</th>
              <th>å®¢æˆ¶åç¨±</th>
            </tr>
          </thead>
          <tbody>
            {% for m in matches %}
            <tr>
              <td>
                <a href="/?device_id={{m.device_id}}" style="text-decoration: none; color: blue;">
                  {{m.device_id}}
                </a>
              </td>
              <td>{{m.customer_name}}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}

    {% if contract %}
    <hr>

    <!-- å®¢æˆ¶è³‡æ–™å€å¡Š -->
    {% if customer %}
    <h3 style="font-size:22px;">å®¢æˆ¶è³‡æ–™</h3>
    <table class="contract-table">
        <tr><th>é …ç›®</th><th>å…§å®¹</th></tr>
        <tr><td>å®¢æˆ¶åç¨±</td><td>{{ customer.customer_name }}</td></tr>
        <tr><td>è¨­å‚™ç·¨è™Ÿ</td><td>{{ customer.device_id }}</td></tr>
        <tr><td>æ©Ÿè™Ÿ</td><td>{{ customer.device_number }}</td></tr>
        <tr><td>æ©Ÿå‹</td><td>{{ customer.machine_model }}</td></tr>
        <tr><td>çµ±ä¸€ç·¨è™Ÿ</td><td>{{ customer.tax_id }}</td></tr>
        <tr><td>è£æ©Ÿåœ°å€</td><td>{{ customer.install_address }}</td></tr>
        <tr><td>æœå‹™äººå“¡</td><td>{{ customer.service_person }}</td></tr>
        <tr><td>å¥‘ç´„ç·¨è™Ÿ</td><td>{{ customer.contract_number }}</td></tr>
        <tr><td>åˆç´„é–‹å§‹æ—¥</td><td>{{ customer.contract_start }}</td></tr>
        <tr><td>åˆç´„åˆ°æœŸæ—¥</td><td>{{ customer.contract_end }}</td></tr>
    </table>
    {% endif %}

    <!-- æœ¬æœˆæŠ„è¡¨è¡¨å–® -->
    <form method="POST" style="margin-top:20px;">
        <input type="hidden" name="device_id" value="{{ contract.device_id }}">
        <input type="hidden" name="mode" value="calculate">

        <div class="header-flex" style="font-size:18px;width:80%; margin-top:20px;">
            <h4>è¼¸å…¥ç•¶æœˆæŠ„è¡¨ï¼ˆå¯«å…¥è³‡æ–™åº«ï¼‰
            {% if last_time %}
                - ä¸Šæ¬¡æŠ„è¡¨æ—¥æœŸï¼š{{ last_time }}
            {% endif %}</h4>
        </div>

        <div>
            å‰æ¬¡å½©è‰²å¼µæ•¸: <input type="text" value="{{ last_color }}" readonly>
            å‰æ¬¡é»‘ç™½å¼µæ•¸: <input type="text" value="{{ last_bw }}" readonly>
        </div>

        <br>

        <div>
            æœ¬æœˆå½©è‰²å¼µæ•¸: <input type="number" name="curr_color" required>
            æœ¬æœˆé»‘ç™½å¼µæ•¸: <input type="number" name="curr_bw" required>
        </div>

        <div style="margin-top:12px;">
            <button type="submit">è¨ˆç®—ä¸¦å„²å­˜æœ¬æœˆæŠ„è¡¨</button>
        </div>
    </form>

    {% if result %}
    <hr>
    <h3 style="font-size:22px;">è¨ˆç®—çµæœ</h3>
    <table class="contract-table">
        <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
        {% for k, v in result.items() %}
        <tr {% if k in ["æœªç¨…å°è¨ˆ", "ç¨…é¡", "å«ç¨…ç¸½é¡"] %} style="background-color: #dfffd6;" {% endif %}>
            <td>{{ k }}</td>
            <td>{{ v }}</td>
        </tr>
        {% endfor %}
    </table>
    {% endif %}

    <!-- å¥‘ç´„æ¢ä»¶å€å¡Š -->
    <div class="header-flex" style="width:80%; margin-top:20px;">
        <h3 style="font-size:22px;">å¥‘ç´„æ¢ä»¶</h3>
    </div>
	
	{% if contra_text %}
	<div style="width:80%; margin-top:10px;">
		<div style="border: 1px solid #aaa; border-radius: 8px; padding: 10px; font-size: 15px; font-family: 'Microsoft JhengHei', sans-serif; white-space: pre-line; background-color:#f8f8f8;">
			{{ contra_text }}
		</div>
	</div>
	{% endif %}


    <form method="POST" style="margin-top:8px;">
        <input type="hidden" name="device_id" value="{{ contract.device_id }}">
        <input type="hidden" name="mode" value="update_contract">

        <table class="contract-table">
            <tr><th>é …ç›®</th><th>æ•¸å€¼</th></tr>
            <tr><td>æœˆç§Ÿé‡‘</td><td><input type="number" step="0.01" name="monthly_rent" value="{{ contract.monthly_rent }}"></td></tr>
            <tr><td>å½©è‰²å–®åƒ¹</td><td><input type="number" step="0.01" name="color_unit_price" value="{{ contract.color_unit_price }}"></td></tr>
            <tr><td>é»‘ç™½å–®åƒ¹</td><td><input type="number" step="0.01" name="bw_unit_price" value="{{ contract.bw_unit_price }}"></td></tr>
            <tr><td>å½©è‰²è´ˆé€å¼µæ•¸</td><td><input type="number" name="color_giveaway" value="{{ contract.color_giveaway }}"></td></tr>
            <tr><td>é»‘ç™½è´ˆé€å¼µæ•¸</td><td><input type="number" name="bw_giveaway" value="{{ contract.bw_giveaway }}"></td></tr>
            <tr><td>å½©è‰²èª¤å°ç‡ (å°æ•¸)</td><td><input type="number" step="0.0001" name="color_error_rate" value="{{ contract.color_error_rate }}"></td></tr>
            <tr><td>é»‘ç™½èª¤å°ç‡ (å°æ•¸)</td><td><input type="number" step="0.0001" name="bw_error_rate" value="{{ contract.bw_error_rate }}"></td></tr>
            <tr><td>å½©è‰²åŸºæœ¬å¼µæ•¸</td><td><input type="number" name="color_basic" value="{{ contract.color_basic }}"></td></tr>
            <tr><td>é»‘ç™½åŸºæœ¬å¼µæ•¸</td><td><input type="number" name="bw_basic" value="{{ contract.bw_basic }}"></td></tr>
            <tr><td>å‰æ¬¡å½©è‰²å¼µæ•¸</td><td><input type="text" value="{{ last_color }}" readonly></td></tr>
            <tr><td>å‰æ¬¡é»‘ç™½å¼µæ•¸</td><td><input type="text" value="{{ last_bw }}" readonly></td></tr>
            <tr><td>ç¨…åˆ¥</td>
                <td>
                    <select name="tax_type">
                        <option value="æœªç¨…" {% if contract.tax_type == "æœªç¨…" %}selected{% endif %}>æœªç¨…</option>
                        <option value="å«ç¨…" {% if contract.tax_type == "å«ç¨…" %}selected{% endif %}>å«ç¨…</option>
                    </select>
                </td>
            </tr>
        </table>

        <div style="margin-top:12px;">
            <button type="submit">æ›´æ–°å¥‘ç´„æ¢ä»¶</button>
        </div>
    </form>

    {% endif %}
</body>
</html>
